name: Docker Compose CI

on:
  push:
    branches: [main, develop]
    paths:
      - '.devops/**'
      - 'docker-compose*.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - '.devops/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate docker-compose
        run: docker compose -f .devops/docker-compose.yml config
        
  build-all:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Build all services
        run: docker compose -f .devops/docker-compose.yml build
        
  integration-test:
    needs: build-all
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Start services
        run: |
          docker compose -f .devops/docker-compose.yml up -d
          sleep 30
          
      - name: Health check API
        run: |
          curl --retry 5 --retry-delay 5 --retry-connrefused http://localhost:5000/health || true
          
      - name: Health check AI Agent
        run: |
          curl --retry 5 --retry-delay 5 --retry-connrefused http://localhost:8000/health || true
          
      - name: Stop services
        run: docker compose -f .devops/docker-compose.yml down -v
        if: always()
