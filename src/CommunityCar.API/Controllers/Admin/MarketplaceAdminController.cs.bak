using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using CommunityCar.Application.Common.Interfaces;
using CommunityCar.Domain.Entities.Marketplace.Products;
using CommunityCar.Domain.Entities.Marketplace.Orders;
using CommunityCar.Domain.Entities.Marketplace.Auctions;
using CommunityCar.Domain.Entities.Marketplace.Reviews;
using CommunityCar.Domain.Entities.Profiles;
using Microsoft.EntityFrameworkCore;

namespace CommunityCar.API.Controllers.Admin;

[ApiController]
[Route("api/admin/marketplace")]
[Authorize(Roles = "Admin,SuperAdmin")]
[ApiExplorerSettings(GroupName = "admin")]
public class MarketplaceAdminController : ControllerBase
{
    private readonly IAppDbContext _context;

    public MarketplaceAdminController(IAppDbContext context) => _context = context;

    // Products
    [HttpGet("products")]
    public async Task<IActionResult> GetProducts([FromQuery] int page = 1, [FromQuery] int pageSize = 20, [FromQuery] string? status = null, CancellationToken ct = default)
    {
        var query = _context.Set<Product>().Include(p => p.Seller).AsQueryable();
        if (!string.IsNullOrEmpty(status)) query = query.Where(p => p.Status.ToString() == status);
        var total = await query.CountAsync(ct);
        var items = await query.OrderByDescending(p => p.CreatedAt).Skip((page - 1) * pageSize).Take(pageSize)
            .Select(p => new { p.Id, p.Title, SellerName = p.Seller.BusinessName, p.Price, p.Status, p.ViewCount, p.IsFeatured, p.CreatedAt }).ToListAsync(ct);
        return Ok(new { items, total, page, pageSize });
    }

    [HttpPut("products/{id}/status")]
    public async Task<IActionResult> UpdateProductStatus(Guid id, [FromBody] UpdateStatusRequest request, CancellationToken ct)
    {
        var product = await _context.Set<Product>().FindAsync([id], ct);
        if (product is null) return NotFound();
        product.Status = Enum.Parse<ProductStatus>(request.Status);
        await _context.SaveChangesAsync(ct);
        return NoContent();
    }

    [HttpPut("products/{id}/feature")]
    public async Task<IActionResult> FeatureProduct(Guid id, [FromBody] FeatureRequest request, CancellationToken ct)
    {
        var product = await _context.Set<Product>().FindAsync([id], ct);
        if (product is null) return NotFound();
        product.IsFeatured = request.IsFeatured;
        await _context.SaveChangesAsync(ct);
        return NoContent();
    }

    [HttpDelete("products/{id}")]
    public async Task<IActionResult> DeleteProduct(Guid id, CancellationToken ct)
    {
        var product = await _context.Set<Product>().FindAsync([id], ct);
        if (product is null) return NotFound();
        product.Status = ProductStatus.Removed;
        await _context.SaveChangesAsync(ct);
        return NoContent();
    }

    // Orders
    [HttpGet("orders")]
    public async Task<IActionResult> GetOrders([FromQuery] int page = 1, [FromQuery] int pageSize = 20, [FromQuery] string? status = null, CancellationToken ct = default)
    {
        var query = _context.Set<Order>().Include(o => o.Buyer).Include(o => o.Seller).AsQueryable();
        if (!string.IsNullOrEmpty(status)) query = query.Where(o => o.Status.ToString() == status);
        var total = await query.CountAsync(ct);
        var items = await query.OrderByDescending(o => o.CreatedAt).Skip((page - 1) * pageSize).Take(pageSize)
            .Select(o => new { o.Id, o.OrderNumber, BuyerName = o.Buyer.UserName, SellerName = o.Seller.BusinessName, o.TotalAmount, o.Status, o.CreatedAt }).ToListAsync(ct);
        return Ok(new { items, total, page, pageSize });
    }

    [HttpGet("orders/{id}")]
    public async Task<IActionResult> GetOrder(Guid id, CancellationToken ct)
    {
        var order = await _context.Set<Order>()
            .Include(o => o.Buyer).Include(o => o.Seller).Include(o => o.Items).ThenInclude(i => i.Product)
            .FirstOrDefaultAsync(o => o.Id == id, ct);
        if (order is null) return NotFound();
        return Ok(order);
    }

    [HttpPut("orders/{id}/status")]
    public async Task<IActionResult> UpdateOrderStatus(Guid id, [FromBody] UpdateStatusRequest request, CancellationToken ct)
    {
        var order = await _context.Set<Order>().FindAsync([id], ct);
        if (order is null) return NotFound();
        order.Status = Enum.Parse<OrderStatus>(request.Status);
        await _context.SaveChangesAsync(ct);
        return NoContent();
    }

    // Auctions
    [HttpGet("auctions")]
    public async Task<IActionResult> GetAuctions([FromQuery] int page = 1, [FromQuery] int pageSize = 20, CancellationToken ct = default)
    {
        var query = _context.Set<Auction>().Include(a => a.Seller);
        var total = await query.CountAsync(ct);
        var items = await query.OrderByDescending(a => a.CreatedAt).Skip((page - 1) * pageSize).Take(pageSize)
            .Select(a => new { a.Id, a.Title, SellerName = a.Seller.BusinessName, a.StartingPrice, a.CurrentBid, a.BidCount, a.Status, a.EndDate }).ToListAsync(ct);
        return Ok(new { items, total, page, pageSize });
    }

    [HttpPut("auctions/{id}/status")]
    public async Task<IActionResult> UpdateAuctionStatus(Guid id, [FromBody] UpdateStatusRequest request, CancellationToken ct)
    {
        var auction = await _context.Set<Auction>().FindAsync([id], ct);
        if (auction is null) return NotFound();
        auction.Status = Enum.Parse<AuctionStatus>(request.Status);
        await _context.SaveChangesAsync(ct);
        return NoContent();
    }

    // Sellers
    [HttpGet("sellers")]
    public async Task<IActionResult> GetSellers([FromQuery] int page = 1, [FromQuery] int pageSize = 20, CancellationToken ct = default)
    {
        var query = _context.Set<VendorProfile>().Include(s => s.User);
        var total = await query.CountAsync(ct);
        var items = await query.OrderByDescending(s => s.CreatedAt).Skip((page - 1) * pageSize).Take(pageSize)
            .Select(s => new { s.Id, s.BusinessName, UserName = s.User.UserName, s.IsVerified, s.Rating, s.TotalSales, s.Status, s.CreatedAt }).ToListAsync(ct);
        return Ok(new { items, total, page, pageSize });
    }

    [HttpPut("sellers/{id}/verify")]
    public async Task<IActionResult> VerifySeller(Guid id, [FromBody] VerifyRequest request, CancellationToken ct)
    {
        var seller = await _context.Set<VendorProfile>().FindAsync([id], ct);
        if (seller is null) return NotFound();
        seller.IsVerified = request.IsVerified;
        seller.VerifiedAt = request.IsVerified ? DateTime.UtcNow : null;
        await _context.SaveChangesAsync(ct);
        return NoContent();
    }

    [HttpPut("sellers/{id}/status")]
    public async Task<IActionResult> UpdateSellerStatus(Guid id, [FromBody] UpdateStatusRequest request, CancellationToken ct)
    {
        var seller = await _context.Set<VendorProfile>().FindAsync([id], ct);
        if (seller is null) return NotFound();
        seller.Status = Enum.Parse<VendorStatus>(request.Status);
        await _context.SaveChangesAsync(ct);
        return NoContent();
    }

    // Reviews
    [HttpGet("reviews")]
    public async Task<IActionResult> GetReviews([FromQuery] int page = 1, [FromQuery] int pageSize = 20, [FromQuery] bool? flagged = null, CancellationToken ct = default)
    {
        var query = _context.Set<ProductReview>().Include(r => r.Reviewer).Include(r => r.Product).AsQueryable();
        if (flagged.HasValue) query = query.Where(r => r.IsFlagged == flagged.Value);
        var total = await query.CountAsync(ct);
        var items = await query.OrderByDescending(r => r.CreatedAt).Skip((page - 1) * pageSize).Take(pageSize)
            .Select(r => new { r.Id, ProductTitle = r.Product.Title, ReviewerName = r.Reviewer.UserName, r.Rating, r.Comment, r.IsFlagged, r.IsVerified, r.CreatedAt }).ToListAsync(ct);
        return Ok(new { items, total, page, pageSize });
    }

    [HttpDelete("reviews/{id}")]
    public async Task<IActionResult> DeleteReview(Guid id, CancellationToken ct)
    {
        var review = await _context.Set<ProductReview>().FindAsync([id], ct);
        if (review is null) return NotFound();
        _context.Set<ProductReview>().Remove(review);
        await _context.SaveChangesAsync(ct);
        return NoContent();
    }

    // Analytics
    [HttpGet("analytics")]
    public async Task<IActionResult> GetAnalytics([FromQuery] DateTime? startDate, [FromQuery] DateTime? endDate, CancellationToken ct = default)
    {
        var start = startDate ?? DateTime.UtcNow.AddDays(-30);
        var end = endDate ?? DateTime.UtcNow;

        var orderStats = await _context.Set<Order>()
            .Where(o => o.CreatedAt >= start && o.CreatedAt <= end)
            .GroupBy(o => o.Status)
            .Select(g => new { Status = g.Key.ToString(), Count = g.Count(), Revenue = g.Sum(o => o.TotalAmount) })
            .ToListAsync(ct);

        var topProducts = await _context.Set<Product>()
            .OrderByDescending(p => p.SalesCount)
            .Take(10)
            .Select(p => new { p.Id, p.Title, p.SalesCount, p.ViewCount })
            .ToListAsync(ct);

        var topSellers = await _context.Set<VendorProfile>()
            .OrderByDescending(s => s.TotalSales)
            .Take(10)
            .Select(s => new { s.Id, s.BusinessName, s.TotalSales, s.Rating })
            .ToListAsync(ct);

        return Ok(new { OrderStats = orderStats, TopProducts = topProducts, TopSellers = topSellers });
    }
}


