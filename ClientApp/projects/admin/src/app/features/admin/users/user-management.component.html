<div class="user-management">
  <div class="page-header">
    <div class="header-info">
      <h1>User Management</h1>
      <p>Manage platform users and their roles</p>
    </div>
    @if (isSuperAdmin()) {
      <button class="btn-primary" (click)="openCreateModal()">
        <span>+</span> Add New User
      </button>
    }
  </div>

  <!-- Filters -->
  <div class="filters-card">
    <input
      type="text"
      [(ngModel)]="searchTerm"
      (input)="onSearch()"
      placeholder="Search users..."
      class="search-input"
    />
    <select [(ngModel)]="selectedRole" (change)="loadUsers()" class="filter-select">
      <option value="">All Roles</option>
      <option value="SuperAdmin">Super Admin</option>
      <option value="UserAdmin">User Admin</option>
      <option value="ContentAdmin">Content Admin</option>
      <option value="Expert">Expert</option>
      <option value="Reviewer">Reviewer</option>
      <option value="User">User</option>
    </select>
    <select [(ngModel)]="selectedStatus" (change)="loadUsers()" class="filter-select">
      <option value="">All Status</option>
      <option value="Active">Active</option>
      <option value="Inactive">Inactive</option>
      <option value="Banned">Banned</option>
      <option value="PendingApproval">Pending</option>
    </select>
  </div>

  <!-- Loading -->
  <div *ngIf="loading()" class="loading-container">
    <div class="spinner"></div>
  </div>

  <!-- Error -->
  <div *ngIf="error()" class="error-message">
    {{ error() }}
    <button (click)="loadUsers()" class="retry-btn">Retry</button>
  </div>

  <!-- Users Table -->
  <div *ngIf="!loading() && !error()" class="table-container">
    <table class="users-table">
      <thead>
        <tr>
          <th>User</th>
          <th>Email</th>
          <th>Roles</th>
          <th>Status</th>
          <th>Joined</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of users()">
          <td>
            <div class="user-cell">
              <div class="avatar">{{ getInitials(user) }}</div>
              <div class="user-info">
                <span class="user-name">{{ user.firstName }} {{ user.lastName }}</span>
                <span class="user-username">{{ user.userName }}</span>
              </div>
            </div>
          </td>
          <td>{{ user.email }}</td>
          <td>
            <div class="roles-list">
              <span
                *ngFor="let role of user.roles"
                class="role-badge"
                [ngClass]="getRoleBadgeClass(role)"
              >
                {{ role }}
              </span>
            </div>
          </td>
          <td>
            <span class="status-badge" [ngClass]="getStatusBadgeClass(user.accountStatus)">
              {{ user.accountStatus }}
            </span>
          </td>
          <td>{{ user.createdAt | date : "mediumDate" }}</td>
          <td>
            <div class="actions">
              <button class="action-btn edit" (click)="editUser(user)">Edit</button>
              <button
                *ngIf="user.accountStatus !== 'Active'"
                class="action-btn activate"
                (click)="activateUser(user)"
              >
                Activate
              </button>
              <button
                *ngIf="user.accountStatus === 'Active'"
                class="action-btn block"
                (click)="blockUser(user)"
              >
                Block
              </button>
            </div>
          </td>
        </tr>
        <tr *ngIf="users().length === 0">
          <td colspan="6" class="empty-state">No users found matching your criteria</td>
        </tr>
      </tbody>
    </table>

    <!-- Pagination -->
    <div class="pagination">
      <span class="pagination-info">
        Showing {{ (currentPage - 1) * pageSize + 1 }} to
        {{ Math.min(currentPage * pageSize, totalCount) }} of {{ totalCount }} users
      </span>
      <div class="pagination-buttons">
        <button (click)="prevPage()" [disabled]="currentPage === 1" class="page-btn">
          Previous
        </button>
        <button (click)="nextPage()" [disabled]="currentPage >= totalPages" class="page-btn">
          Next
        </button>
      </div>
    </div>
  </div>

  <!-- Create User Modal (SuperAdmin Only) -->
  @if (showCreateModal && isSuperAdmin()) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          @if (createStep() === 'select-type') {
            <h2>Add New</h2>
          } @else {
            <h2>Create New {{ selectedUserType() === 'admin' ? 'Admin' : 'User' }}</h2>
          }
          <button class="close-btn" (click)="closeModal()">‚úï</button>
        </div>
        
        @if (createSuccess()) {
          <div class="success-message">
            <span class="success-icon">‚úì</span>
            <p>{{ selectedUserType() === 'admin' ? 'Admin' : 'User' }} created successfully!</p>
          </div>
        } @else if (createStep() === 'select-type') {
          <!-- Step 1: Select User Type -->
          <div class="type-selection">
            <p class="type-selection-title">What type of account do you want to create?</p>
            <div class="type-options">
              <button class="type-option" (click)="selectUserType('user')">
                <span class="type-icon">üë§</span>
                <span class="type-name">User</span>
                <span class="type-desc">Regular platform users, experts, reviewers, vendors</span>
              </button>
              <button class="type-option admin" (click)="selectUserType('admin')">
                <span class="type-icon">üõ°Ô∏è</span>
                <span class="type-name">Admin</span>
                <span class="type-desc">Moderators, content admins, user admins, super admins</span>
              </button>
            </div>
          </div>
        } @else {
          <!-- Step 2: Create Form -->
          <form (ngSubmit)="createUser()">
            @if (createError()) {
              <div class="error-alert">{{ createError() }}</div>
            }
            
            <div class="form-group">
              <label>Email <span class="required">*</span></label>
              <input type="email" [(ngModel)]="newUser.email" name="email" required placeholder="user@example.com" />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>First Name <span class="required">*</span></label>
                <input type="text" [(ngModel)]="newUser.firstName" name="firstName" required placeholder="John" />
              </div>
              <div class="form-group">
                <label>Last Name <span class="required">*</span></label>
                <input type="text" [(ngModel)]="newUser.lastName" name="lastName" required placeholder="Doe" />
              </div>
            </div>
            <div class="form-group">
              <label>Password <span class="required">*</span></label>
              <input type="password" [(ngModel)]="newUser.password" name="password" required placeholder="Min 8 characters" />
              <span class="hint">Must contain uppercase, lowercase, number, and special character</span>
            </div>
            <div class="form-group">
              <label>Role <span class="required">*</span></label>
              <select [(ngModel)]="newUser.roleType" name="roleType">
                @for (role of getCurrentRoles(); track role) {
                  <option [value]="role">{{ role }}</option>
                }
              </select>
            </div>
            <div class="modal-actions">
              <button type="button" class="btn-secondary" (click)="goBackToTypeSelection()" [disabled]="creating()">
                ‚Üê Back
              </button>
              <button type="submit" class="btn-primary" [disabled]="creating()">
                @if (creating()) {
                  <span class="spinner-small"></span> Creating...
                } @else {
                  Create {{ selectedUserType() === 'admin' ? 'Admin' : 'User' }}
                }
              </button>
            </div>
          </form>
        }
      </div>
    </div>
  }
</div>
