<article class="bg-white dark:bg-gray-900 rounded-lg shadow-sm overflow-hidden mb-4">
  <!-- Post Header -->
  <div class="flex justify-between items-start p-3">
    <a [routerLink]="['/profile', post().authorId]" class="flex gap-3 no-underline text-inherit">
      <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary to-success text-white flex items-center justify-center font-semibold text-sm overflow-hidden flex-shrink-0">
        @if (post().author.avatarUrl) {
          <img [src]="post().author.avatarUrl" [alt]="post().author.firstName" class="w-full h-full object-cover">
        } @else {
          <span>{{ getAuthorInitials() }}</span>
        }
      </div>
      <div>
        <span class="font-semibold text-sm text-gray-900 dark:text-white hover:underline">{{ post().author.firstName }} {{ post().author.lastName }}</span>
        <div class="flex items-center gap-1.5 text-xs text-gray-600 dark:text-gray-400">
          <span>{{ getTimeAgo(post().publishedAt || post().createdAt) }}</span>
          <span class="flex items-center">
            @if (post().visibility === 'Public') {
              <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor" title="Public">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
              </svg>
            } @else if (post().visibility === 'FriendsOnly') {
              <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor" title="Friends">
                <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
              </svg>
            } @else {
              <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor" title="Private">
                <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
              </svg>
            }
          </span>
        </div>
      </div>
    </a>

    <!-- Post Menu -->
    <div class="relative">
      <button class="w-9 h-9 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center transition-colors" (click)="toggleMenu()">
        <svg class="w-5 h-5 text-gray-600 dark:text-gray-400" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
        </svg>
      </button>
      @if (showMenu()) {
        <div class="absolute top-full right-0 bg-white dark:bg-gray-900 rounded-lg shadow-lg border border-gray-200 dark:border-gray-800 min-w-[200px] z-50 overflow-hidden">
          <button class="flex items-center gap-3 w-full px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-800 text-left text-sm text-gray-900 dark:text-white transition-colors">
            <svg class="w-5 h-5 text-gray-600 dark:text-gray-400" viewBox="0 0 24 24" fill="currentColor">
              <path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2z"/>
            </svg>
            Save post
          </button>
          <button class="flex items-center gap-3 w-full px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-800 text-left text-sm text-gray-900 dark:text-white transition-colors">
            <svg class="w-5 h-5 text-gray-600 dark:text-gray-400" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
            Hide post
          </button>
          @if (isOwner()) {
            <hr class="border-gray-200 dark:border-gray-800 my-1">
            <button class="flex items-center gap-3 w-full px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-800 text-left text-sm text-gray-900 dark:text-white transition-colors" [routerLink]="['/community/post', post().id, 'edit']">
              <svg class="w-5 h-5 text-gray-600 dark:text-gray-400" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
              </svg>
              Edit post
            </button>
            <button class="flex items-center gap-3 w-full px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-800 text-left text-sm text-error transition-colors" (click)="deletePost()">
              <svg class="w-5 h-5 text-error" viewBox="0 0 24 24" fill="currentColor">
                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
              </svg>
              Delete post
            </button>
          }
        </div>
      }
    </div>
  </div>

  <!-- Post Content -->
  <div class="px-4 pb-3">
    @if (post().title && post().type !== 'General') {
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">{{ post().title }}</h3>
    }
    <p class="text-sm leading-relaxed whitespace-pre-wrap break-words text-gray-900 dark:text-white" [innerHTML]="post().content"></p>
  </div>

  <!-- Post Media -->
  @if (post().media && post().media.length > 0) {
    <div class="relative" [class.grid]="post().media.length > 1" [class.grid-cols-2]="post().media.length === 2" [class.gap-0.5]="post().media.length > 1" [class.grid-rows-2]="post().media.length >= 3">
      @for (media of post().media.slice(0, 4); track media.id) {
        <div class="relative overflow-hidden" [class.row-span-2]="$index === 0 && post().media.length >= 3">
          @if (media.type === 'image') {
            <img [src]="media.url" [alt]="post().title" class="w-full h-full object-cover">
          } @else {
            <video [src]="media.url" controls class="w-full h-full object-cover"></video>
          }
          @if ($index === 3 && post().media.length > 4) {
            <div class="absolute inset-0 bg-black/50 flex items-center justify-center text-white text-3xl font-semibold">
              +{{ post().media.length - 4 }}
            </div>
          }
        </div>
      }
    </div>
  } @else if (post().coverImageUrl) {
    <div>
      <img [src]="post().coverImageUrl" [alt]="post().title" class="w-full block">
    </div>
  }

  <!-- Post Stats -->
  <div class="flex justify-between px-4 py-2.5 text-gray-600 dark:text-gray-400 text-sm">
    <div class="flex items-center gap-1">
      @if (likeCount() > 0) {
        <span class="flex items-center gap-1">
          <span class="inline-flex items-center justify-center w-4.5 h-4.5 bg-primary rounded-full text-xs">üëç</span>
          {{ likeCount() }}
        </span>
      }
    </div>
    <div class="flex gap-3">
      @if (post().commentCount > 0) {
        <button (click)="toggleComments()" class="hover:underline">{{ post().commentCount }} comments</button>
      }
      @if (post().shareCount > 0) {
        <span>{{ post().shareCount }} shares</span>
      }
    </div>
  </div>

  <!-- Post Actions -->
  <div class="flex border-t border-gray-200 dark:border-gray-800 px-2 py-1">
    <button class="flex-1 flex items-center justify-center gap-2 px-2.5 py-2.5 rounded hover:bg-gray-100 dark:hover:bg-gray-800 text-sm font-semibold transition-colors" 
            [class.text-primary]="isLiked()"
            [class.text-gray-600]="!isLiked()"
            [class.dark:text-gray-400]="!isLiked()"
            (click)="toggleLike()">
      <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
        @if (isLiked()) {
          <path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z"/>
        } @else {
          <path d="M9 21h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.58 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2zM9 9l4.34-4.34L12 10h9v2l-3 7H9V9zM1 9h4v12H1z"/>
        }
      </svg>
      <span>Like</span>
    </button>
    <button class="flex-1 flex items-center justify-center gap-2 px-2.5 py-2.5 rounded hover:bg-gray-100 dark:hover:bg-gray-800 text-sm font-semibold text-gray-600 dark:text-gray-400 transition-colors" (click)="toggleComments()">
      <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
        <path d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18zM18 14H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
      </svg>
      <span>Comment</span>
    </button>
    <button class="flex-1 flex items-center justify-center gap-2 px-2.5 py-2.5 rounded hover:bg-gray-100 dark:hover:bg-gray-800 text-sm font-semibold text-gray-600 dark:text-gray-400 transition-colors" (click)="sharePost()">
      <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
        <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
      </svg>
      <span>Share</span>
    </button>
  </div>

  <!-- Comments Section -->
  @if (showComments()) {
    <div class="border-t border-gray-200 dark:border-gray-800 px-4 py-3">
      <!-- Comment Input -->
      @if (user()) {
        <div class="flex gap-2 mb-3">
          <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-purple-700 text-white flex items-center justify-center font-semibold text-xs flex-shrink-0">
            {{ getUserInitials() }}
          </div>
          <div class="flex-1 flex bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden">
            <input 
              type="text" 
              placeholder="Write a comment..."
              [(ngModel)]="newComment"
              (keyup.enter)="submitComment()"
              class="flex-1 bg-transparent px-4 py-2 text-sm outline-none text-gray-900 dark:text-white">
            <button class="px-2 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" [disabled]="!newComment().trim()" (click)="submitComment()">
              <svg class="w-5 h-5" [class.text-primary]="newComment().trim()" [class.text-gray-400]="!newComment().trim()" viewBox="0 0 24 24" fill="currentColor">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
              </svg>
            </button>
          </div>
        </div>
      }

      <!-- Comments List -->
      @if (loadingComments()) {
        <div class="text-center py-4 text-gray-600 dark:text-gray-400 text-sm">Loading comments...</div>
      } @else {
        <div class="flex flex-col gap-3">
          @for (comment of comments(); track comment.id) {
            <div class="flex gap-2">
              <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-purple-700 text-white flex items-center justify-center font-semibold text-xs flex-shrink-0">
                {{ comment.author.firstName?.charAt(0) }}{{ comment.author.lastName?.charAt(0) }}
              </div>
              <div class="flex-1">
                <div class="bg-gray-100 dark:bg-gray-800 rounded-2xl px-3 py-2 inline-block">
                  <span class="block font-semibold text-xs text-gray-900 dark:text-white">{{ comment.author.firstName }} {{ comment.author.lastName }}</span>
                  <p class="text-sm text-gray-900 dark:text-white m-0">{{ comment.content }}</p>
                </div>
                <div class="flex gap-3 px-3 mt-1">
                  <button class="text-xs font-semibold text-gray-600 dark:text-gray-400 hover:underline">Like</button>
                  <button class="text-xs font-semibold text-gray-600 dark:text-gray-400 hover:underline">Reply</button>
                  <span class="text-xs text-gray-600 dark:text-gray-400">{{ getTimeAgo(comment.createdAt) }}</span>
                </div>
              </div>
            </div>
          }
        </div>
      }
    </div>
  }
</article>
